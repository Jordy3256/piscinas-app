{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{% block title %}Panel{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="/dashboard/manifest.json">
  <meta name="theme-color" content="#0d6efd">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    .app-shell { max-width: 720px; margin: 0 auto; }
    .topbar { position: sticky; top: 0; z-index: 1030; backdrop-filter: blur(8px); }
    .bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1030; }
    .spacer-bottom { height: 90px; }

    #btn-install { display: none; }

    #template-debug-badge{
      position: fixed;
      right: 10px;
      bottom: 100px;
      z-index: 9999;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #198754;
      color: #fff;
      opacity: .85;
    }

    .notif-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 999px;
    }
    .notif-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 999px;
      font-size: 11px;
      line-height: 18px;
      text-align: center;
      background: #dc3545;
      color: #fff;
      display: none;
    }

    /* ‚úÖ Bot√≥n activar push */
    #btn-push { display: none; white-space: nowrap; }
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="bg-light">
  <div class="app-shell">

    <!-- Topbar -->
    <div class="topbar bg-white border-bottom">
      <div class="container py-3 d-flex justify-content-between align-items-center">
        <div class="fw-bold">{% block top_title %}üßë‚Äçüîß Trabajador{% endblock %}</div>

        <div class="d-flex align-items-center gap-2">
          <button id="btn-push" class="btn btn-primary btn-sm" type="button" title="Activar notificaciones">
            üîî Activar
          </button>

          <a class="btn btn-outline-secondary btn-sm notif-btn"
             href="/dashboard/notificaciones/"
             title="Notificaciones">
            üîî
            <span id="notif-badge" class="notif-badge">0</span>
          </a>

          <a class="btn btn-outline-danger btn-sm" href="/logout/">Salir</a>
        </div>
      </div>
    </div>

    <!-- Contenido -->
    <div class="container py-3">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
        {% endfor %}
      {% endif %}

      {% block content %}{% endblock %}
      <div class="spacer-bottom"></div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav bg-white border-top">
      <div class="container py-2">
        <div class="d-flex gap-2 flex-wrap">
          <a class="btn btn-light flex-fill" href="/dashboard/">üè† Inicio</a>
          <a class="btn btn-outline-secondary flex-fill" href="/dashboard/">üìã Mis mantenimientos</a>
          <a class="btn btn-outline-danger flex-fill" href="/logout/">üö™ Salir</a>

          <button id="btn-install" class="btn btn-primary flex-fill" type="button">
            üì≤ Instalar app
          </button>
        </div>
      </div>
    </div>

  </div>

  <div id="template-debug-badge">BASE_TRABAJADOR ‚úÖ</div>

<script>
  // ==========================================================
  // ‚úÖ Config
  // ==========================================================
  const VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY|default:''|escapejs }}";

  // ==========================================================
  // ‚úÖ CSRF robusto (meta -> cookie)
  // ==========================================================
  function getCSRFToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.getAttribute("content")) return meta.getAttribute("content") || "";
    const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : "";
  }

  // ==========================================================
  // ‚úÖ Utils
  // ==========================================================
  function urlBase64ToUint8Array(base64UrlString) {
    if (!base64UrlString || typeof base64UrlString !== "string") return null;
    const padding = "=".repeat((4 - (base64UrlString.length % 4)) % 4);
    const base64 = (base64UrlString + padding).replace(/-/g, "+").replace(/_/g, "/");
    const raw = atob(base64);
    const out = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
    return out;
  }

  async function unregisterGhostSW() {
    if (!("serviceWorker" in navigator)) return;
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const r of regs) {
      const scope = r?.scope || "";
      if (scope.includes("/static/dashboard/")) {
        console.log("[SW] üßπ Unregister viejo /static/dashboard/:", scope);
        await r.unregister();
      }
    }
  }

  async function registerSW() {
    if (!("serviceWorker" in navigator)) return null;
    await unregisterGhostSW();
    await navigator.serviceWorker.register("/dashboard/sw.js", { scope: "/dashboard/" });
    const ready = await navigator.serviceWorker.ready;
    return ready;
  }

  // ==========================================================
  // ‚úÖ Badge notificaciones (silencioso si 404)
  // ==========================================================
  const notifBadge = document.getElementById("notif-badge");

  async function refreshNotifBadge() {
    if (!notifBadge) return;
    try {
      const res = await fetch("/dashboard/notificaciones/unread-count/", {
        method: "GET",
        credentials: "same-origin",
        headers: { "Accept": "application/json" },
      });
      if (res.status === 404) return;
      if (!res.ok) return;

      const data = await res.json().catch(() => ({}));
      const n = Number(data.unread || 0);

      if (n > 0) {
        notifBadge.textContent = String(n > 99 ? "99+" : n);
        notifBadge.style.display = "inline-block";
      } else {
        notifBadge.style.display = "none";
      }
    } catch (e) {}
  }

  // ==========================================================
  // ‚úÖ Save subscription
  // ==========================================================
  async function sendSubscriptionToServer(sub) {
    const csrftoken = getCSRFToken();

    const res = await fetch("/dashboard/save-subscription/", {
      method: "POST",
      credentials: "same-origin",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
        "Accept": "application/json",
      },
      body: JSON.stringify(sub.toJSON()),
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      console.warn("[PUSH] save-subscription FAILED", res.status, data);
      return { ok: false, status: res.status, data };
    }
    console.log("[PUSH] saved ‚úÖ", data);
    return { ok: true, data };
  }

  // ==========================================================
  // ‚úÖ PUSH (Trabajador)
  // ==========================================================
  const btnPush = document.getElementById("btn-push");
  function showPushButton() { if (btnPush) btnPush.style.display = "inline-block"; }
  function hidePushButton() { if (btnPush) btnPush.style.display = "none"; }

  async function syncPushButton(reg) {
    try {
      if (!btnPush) return;

      if (!reg || !("PushManager" in window) || !("Notification" in window)) {
        hidePushButton();
        return;
      }

      const sub = await reg.pushManager.getSubscription();
      const granted = (Notification.permission === "granted");

      if (sub && granted) hidePushButton();
      else showPushButton();
    } catch (e) {
      console.error("[PUSH] syncPushButton error:", e);
      showPushButton();
    }
  }

  async function enablePush() {
    try {
      const reg = await navigator.serviceWorker.ready;

      const perm = await Notification.requestPermission();
      if (perm !== "granted") {
        alert("No concediste el permiso de notificaciones.");
        return;
      }

      let sub = await reg.pushManager.getSubscription();
      if (!sub) {
        const keyBytes = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
        if (!keyBytes || !keyBytes.length) {
          alert("VAPID_PUBLIC_KEY inv√°lida (debe ser base64url).");
          console.error("[PUSH] keyBytes inv√°lido", VAPID_PUBLIC_KEY);
          return;
        }
        sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: keyBytes,
        });
      }

      const saved = await sendSubscriptionToServer(sub);
      if (saved.ok) {
        alert("‚úÖ Notificaciones activadas.");
        hidePushButton();
      } else {
        alert("‚ö†Ô∏è Suscripci√≥n creada pero no se guard√≥ en el servidor. Revisa consola.");
      }
    } catch (e) {
      console.error("[PUSH] enablePush error:", e);
      alert("Error activando notificaciones. Revisa consola.");
    }
  }

  if (btnPush) btnPush.addEventListener("click", enablePush);

  // ==========================================================
  // ‚úÖ PWA Install
  // ==========================================================
  (function () {
    const btnInstall = document.getElementById("btn-install");
    let deferredPrompt = null;

    function isStandalone() {
      return window.matchMedia("(display-mode: standalone)").matches
        || window.matchMedia("(display-mode: fullscreen)").matches
        || window.navigator.standalone === true;
    }

    function hideInstallButton() {
      if (!btnInstall) return;
      btnInstall.style.display = "none";
    }

    function showFallbackInstallHelp() {
      if (!btnInstall) return;
      btnInstall.style.display = "inline-block";
      btnInstall.textContent = "üìå Instalar (men√∫ ‚ãÆ del navegador)";
      btnInstall.onclick = () => {
        alert("En Chrome/Edge: men√∫ ‚ãÆ ‚Üí 'Instalar app' o 'Agregar a pantalla de inicio'.");
      };
    }

    function showRealInstallButton() {
      if (!btnInstall) return;
      btnInstall.style.display = "inline-block";
      btnInstall.textContent = "üì≤ Instalar app";
      btnInstall.onclick = null;
    }

    function syncInstallButton() {
      if (!btnInstall) return;
      if (isStandalone()) return hideInstallButton();
      if (deferredPrompt) return showRealInstallButton();
      showFallbackInstallHelp();
    }

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      syncInstallButton();
    });

    if (btnInstall) {
      btnInstall.addEventListener("click", async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        syncInstallButton();
      });
    }

    window.addEventListener("appinstalled", () => {
      deferredPrompt = null;
      syncInstallButton();
    });

    syncInstallButton();
  })();

  // ==========================================================
  // ‚úÖ Boot
  // ==========================================================
  window.addEventListener("load", async () => {
    const reg = await registerSW();
    await syncPushButton(reg);

    refreshNotifBadge();
    setInterval(refreshNotifBadge, 30000);
  });
</script>

{% block extra_js %}{% endblock %}
</body>
</html>