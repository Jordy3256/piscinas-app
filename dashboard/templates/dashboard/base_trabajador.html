{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Panel{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="/dashboard/manifest.json">
  <meta name="theme-color" content="#0d6efd">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    .app-shell { max-width: 720px; margin: 0 auto; }
    .topbar { position: sticky; top: 0; z-index: 1030; backdrop-filter: blur(8px); }
    .bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1030; }
    .spacer-bottom { height: 90px; }
    #btn-install { display: none; }

    #template-debug-badge{
      position: fixed;
      right: 10px;
      bottom: 100px;
      z-index: 9999;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #198754;
      color: #fff;
      opacity: .85;
    }

    .notif-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 999px;
    }
    .notif-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 999px;
      font-size: 11px;
      line-height: 18px;
      text-align: center;
      background: #dc3545;
      color: #fff;
      display: none;
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="bg-light">
  <div class="app-shell">

    <!-- Topbar -->
    <div class="topbar bg-white border-bottom">
      <div class="container py-3 d-flex justify-content-between align-items-center">
        <div class="fw-bold">{% block top_title %}üßë‚Äçüîß Trabajador{% endblock %}</div>

        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-outline-secondary btn-sm notif-btn"
             href="/dashboard/notificaciones/"
             title="Notificaciones">
            üîî
            <span id="notif-badge" class="notif-badge">0</span>
          </a>

          <a class="btn btn-outline-danger btn-sm" href="/logout/">Salir</a>
        </div>
      </div>
    </div>

    <!-- Contenido -->
    <div class="container py-3">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
        {% endfor %}
      {% endif %}

      {% block content %}{% endblock %}
      <div class="spacer-bottom"></div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav bg-white border-top">
      <div class="container py-2">
        <div class="d-flex gap-2 flex-wrap">
          <a class="btn btn-light flex-fill" href="/dashboard/">üè† Inicio</a>
          <a class="btn btn-outline-secondary flex-fill" href="/dashboard/">üìã Mis mantenimientos</a>
          <a class="btn btn-outline-danger flex-fill" href="/logout/">üö™ Salir</a>

          <button id="btn-install" class="btn btn-primary flex-fill" type="button">
            üì≤ Instalar app
          </button>

          <!-- ‚úÖ activar push manual -->
          <button id="btn-enable-push" class="btn btn-outline-primary flex-fill" type="button">
            üîî Activar notificaciones
          </button>
        </div>
      </div>
    </div>

  </div>

  <div id="template-debug-badge">BASE_TRABAJADOR ‚úÖ</div>

<script>
  console.log("[TRABAJADOR] base_trabajador.html cargado ‚úÖ");

  // ==========================================================
  // Badge notificaciones
  // ==========================================================
  const notifBadge = document.getElementById("notif-badge");
  async function refreshNotifBadge() {
    if (!notifBadge) return;
    try {
      const res = await fetch("/dashboard/notificaciones/unread-count/", {
        method: "GET",
        credentials: "same-origin",
        headers: { "Accept": "application/json" },
      });
      if (!res.ok) return;
      const data = await res.json();
      const n = Number(data.unread || 0);

      if (n > 0) {
        notifBadge.textContent = String(n > 99 ? "99+" : n);
        notifBadge.style.display = "inline-block";
      } else {
        notifBadge.style.display = "none";
      }
    } catch (e) {}
  }

  // ==========================================================
  // ‚úÖ enablePush SIEMPRE definido
  // ==========================================================
  (function () {
    window.enablePush = async function () {
      try {
        if (!("serviceWorker" in navigator)) return console.warn("[SW] no soportado");
        if (!("PushManager" in window) || !("Notification" in window)) return console.warn("[PUSH] no soportado");

        const reg = await navigator.serviceWorker.ready;

        if (Notification.permission === "denied") {
          console.warn("[PUSH] permiso denegado");
          return;
        }

        if (Notification.permission === "default") {
          const perm = await Notification.requestPermission();
          console.log("[PUSH] permission:", perm);
          if (perm !== "granted") return;
        }

        const r = await fetch("/dashboard/push/public-key/", { credentials: "same-origin" });
        if (!r.ok) throw new Error("public-key status " + r.status);
        const data = await r.json();
        const publicKey = (data.publicKey || "").replace(/\s+/g, "").trim();

        function urlBase64ToUint8Array(base64String) {
          base64String = (base64String || "").replace(/\s+/g, "").trim();
          const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
          const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
          const raw = atob(base64);
          const out = new Uint8Array(raw.length);
          for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
          return out;
        }

        let sub = await reg.pushManager.getSubscription();
        console.log("[PUSH] current:", sub ? sub.toJSON() : null);

        if (!sub) {
          sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey),
          });
          console.log("[PUSH] new:", sub.toJSON());
        }

        function getCookie(name) {
          const value = ; ${document.cookie};
          const parts = value.split(; ${name}=);
          if (parts.length === 2) return parts.pop().split(";").shift();
          return "";
        }

        const csrftoken = getCookie("csrftoken");
        const save = await fetch("/dashboard/save-subscription/", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify(sub.toJSON()),
        });

        const out = await save.json().catch(() => ({}));
        console.log("[PUSH] save:", save.status, out);

      } catch (e) {
        console.error("[enablePush] error:", e);
      }
    };

    window.addEventListener("load", () => {
      const btn = document.getElementById("btn-enable-push");
      if (btn) btn.addEventListener("click", () => window.enablePush());
    });
  })();

  // ==========================================================
  // ‚úÖ SW register + limpieza SW fantasma
  // ==========================================================
  (function () {
    if (!("serviceWorker" in navigator)) return;

    window.addEventListener("load", async () => {
      try {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (const r of regs) {
          const scope = r?.scope || "";
          if (scope.includes("/static/dashboard/")) {
            console.log("[SW] üßπ unregister viejo:", scope);
            await r.unregister();
          }
        }

        const reg = await navigator.serviceWorker.register("/dashboard/sw.js", { scope: "/dashboard/" });
        console.log("[SW] OK scope:", reg.scope);

        await navigator.serviceWorker.ready;
        console.log("[SW] ready ‚úÖ");

        // No auto-forzar, mejor con bot√≥n:
        // window.enablePush();

      } catch (e) {
        console.error("[SW] error:", e);
      }
    });
  })();

  // ==========================================================
  // PWA Install events
  // ==========================================================
  const btnInstall = document.getElementById("btn-install");
  let deferredPrompt = null;

  function isStandalone() {
    return window.matchMedia("(display-mode: standalone)").matches
      || window.matchMedia("(display-mode: fullscreen)").matches
      || window.navigator.standalone === true;
  }

  function syncInstallButton() {
    if (!btnInstall) return;

    if (isStandalone()) {
      btnInstall.style.display = "none";
      return;
    }

    if (deferredPrompt) {
      btnInstall.style.display = "inline-block";
      btnInstall.textContent = "üì≤ Instalar app";
      return;
    }

    btnInstall.style.display = "inline-block";
    btnInstall.textContent = "üìå Instalar (men√∫ ‚ãÆ)";
    btnInstall.onclick = () => {
      alert("En Chrome/Edge: men√∫ ‚ãÆ ‚Üí 'Instalar app' o 'Agregar a pantalla de inicio'.");
    };
  }

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    syncInstallButton();
  });

  if (btnInstall) {
    btnInstall.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      syncInstallButton();
    });
  }

  window.addEventListener("appinstalled", () => {
    deferredPrompt = null;
    syncInstallButton();
  });

  syncInstallButton();
  refreshNotifBadge();
  setInterval(refreshNotifBadge, 30000);
</script>

{% block extra_js %}{% endblock %}
</body>
</html>