{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>

<!-- DEPLOY-MARCA: 2026-02-24-XYZ -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{% block title %}Panel{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- âœ… PWA (SIEMPRE desde /dashboard/) -->
  <link rel="manifest" href="/dashboard/manifest.json?v=20260225">
  <meta name="theme-color" content="#0d6efd">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    .app-shell { max-width: 900px; margin: 0 auto; }
    .topbar { position: sticky; top: 0; z-index: 1030; backdrop-filter: blur(8px); }
    .bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1030; }
    .spacer-bottom { height: 88px; }

    /* âœ… El botÃ³n existe SIEMPRE, JS decide si se muestra */
    #btn-install { display: none; }

    /* âœ… Push */
    #btn-push-app  { display: none; white-space: nowrap; }
    #btn-push-test { display: none; white-space: nowrap; }
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body class="bg-light">
  <div class="app-shell">

    <!-- Topbar fijo -->
     <div class="fw-bold">Panel NUEVO XYZ</div>
    <div class="topbar bg-white border-bottom">
      <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-bold">{% block top_title %}Panel{% endblock %}</div>

          <div class="d-flex gap-2">
            <!-- âœ… Notificaciones tambiÃ©n aquÃ­ -->
            <button id="btn-push-app" class="btn btn-primary btn-sm" type="button">ğŸ”” Activar</button>
            <button id="btn-push-test" class="btn btn-outline-primary btn-sm" type="button">ğŸ§ª Test Push</button>

            <!-- âœ… Inicio ahora va a /dashboard/home/ -->
            <a class="btn btn-outline-secondary btn-sm" href="/dashboard/home/">Inicio</a>
            <a class="btn btn-outline-danger btn-sm" href="/logout/">Salir</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido -->
    <div class="container py-3">
      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
      <div class="spacer-bottom"></div>
    </div>

    <!-- âœ… MenÃº fijo abajo (segÃºn rol) -->
    <div class="bottom-nav bg-white border-top">
      <div class="container py-2">
        <div class="d-flex justify-content-around gap-2 flex-wrap">

          <!-- âœ… Inicio ahora va a /dashboard/home/ -->
          <a class="btn btn-light flex-fill" href="/dashboard/home/">ğŸ  Inicio</a>

          {% if es_admin %}
            <a class="btn btn-outline-secondary flex-fill" href="/dashboard/operativo/">ğŸ§‘â€ğŸ’¼ Operativo</a>
            <a class="btn btn-outline-secondary flex-fill" href="/dashboard/finanzas/flujo/">ğŸ’° Finanzas</a>
          {% else %}
            <a class="btn btn-outline-secondary flex-fill" href="/dashboard/">ğŸ“‹ Mis mantenimientos</a>
          {% endif %}

          <a class="btn btn-outline-danger flex-fill" href="/logout/">ğŸšª Salir</a>

          <!-- âœ… BotÃ³n instalar (para cualquier rol) -->
          <button id="btn-install" class="btn btn-primary flex-fill" type="button">
            ğŸ“² Instalar app
          </button>

        </div>
      </div>
    </div>

  </div>

  <script>
    // ==========================================================
    // âœ… Config
    // ==========================================================
    const VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY|default:''|escapejs }}";

    // ==========================================================
    // âœ… CSRF robusto (meta -> cookie)
    // ==========================================================
    function getCSRFToken() {
      const meta = document.querySelector('meta[name="csrf-token"]');
      if (meta && meta.getAttribute("content")) return meta.getAttribute("content") || "";
      const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : "";
    }

    // ==========================================================
    // âœ… Utils
    // ==========================================================
    function urlBase64ToUint8Array(base64UrlString) {
      if (!base64UrlString || typeof base64UrlString !== "string") return null;
      const padding = "=".repeat((4 - (base64UrlString.length % 4)) % 4);
      const base64 = (base64UrlString + padding).replace(/-/g, "+").replace(/_/g, "/");
      const raw = atob(base64);
      const out = new Uint8Array(raw.length);
      for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
      return out;
    }

    async function unregisterGhostSW() {
      if (!("serviceWorker" in navigator)) return;
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) {
        const scope = r?.scope || "";
        if (scope.includes("/static/dashboard/")) {
          console.log("[SW] ğŸ§¹ Unregister viejo /static/dashboard/:", scope);
          await r.unregister();
        }
      }
    }

    async function registerSW() {
      if (!("serviceWorker" in navigator)) return null;
      await unregisterGhostSW();
      await navigator.serviceWorker.register("/dashboard/sw.js", { scope: "/dashboard/" });
      const ready = await navigator.serviceWorker.ready;
      return ready;
    }

    // ==========================================================
    // âœ… Save subscription (segÃºn tu urls.py)
    // ==========================================================
    async function sendSubscriptionToServer(sub) {
      const csrftoken = getCSRFToken();
      const res = await fetch("/dashboard/push/save_subscription/", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
          "Accept": "application/json",
        },
        body: JSON.stringify(sub.toJSON()),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        console.warn("[PUSH] save_subscription FAILED", res.status, data);
        return { ok: false, status: res.status, data };
      }
      console.log("[PUSH] saved âœ…", data);
      return { ok: true, data };
    }

    // ==========================================================
    // âœ… Push logic (App)
    // ==========================================================
    const btnPushApp  = document.getElementById("btn-push-app");
    const btnPushTest = document.getElementById("btn-push-test");

    function show(el) { if (el) el.style.display = "inline-block"; }
    function hide(el) { if (el) el.style.display = "none"; }

    async function syncPushButtons(reg) {
      if (!btnPushApp && !btnPushTest) return;

      if (!reg || !("PushManager" in window) || !("Notification" in window)) {
        hide(btnPushApp); hide(btnPushTest);
        return;
      }

      const sub = await reg.pushManager.getSubscription();
      const granted = (Notification.permission === "granted");

      if (sub && granted) {
        hide(btnPushApp);
        show(btnPushTest);
      } else {
        show(btnPushApp);
        hide(btnPushTest);
      }
    }

    async function enablePushApp() {
      try {
        const reg = await navigator.serviceWorker.ready;

        const perm = await Notification.requestPermission();
        if (perm !== "granted") {
          alert("No concediste el permiso de notificaciones.");
          return;
        }

        let sub = await reg.pushManager.getSubscription();
        if (!sub) {
          const keyBytes = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
          if (!keyBytes || !keyBytes.length) {
            alert("VAPID_PUBLIC_KEY invÃ¡lida (debe ser base64url).");
            console.error("[PUSH] keyBytes invÃ¡lido", VAPID_PUBLIC_KEY);
            return;
          }
          sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: keyBytes,
          });
        }

        const saved = await sendSubscriptionToServer(sub);
        if (saved.ok) {
          alert("âœ… Notificaciones activadas.");
          await syncPushButtons(reg);
        } else {
          alert("âš ï¸ SuscripciÃ³n creada pero no se guardÃ³ en el servidor. Revisa consola.");
        }
      } catch (e) {
        console.error("[PUSH] enablePushApp error:", e);
        alert("Error activando notificaciones. Revisa consola.");
      }
    }

    async function sendTestPush() {
      try {
        const csrftoken = getCSRFToken();
        const res = await fetch("/dashboard/push/test/", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "X-CSRFToken": csrftoken,
            "Accept": "application/json",
          },
        });

        const data = await res.json().catch(() => ({}));
        console.log("[PUSH TEST]", res.status, data);

        if (res.ok && data.ok) {
          alert("ğŸ“¨ Push test enviado. Revisa si te llegÃ³ la notificaciÃ³n.");
        } else {
          alert("âš ï¸ FallÃ³ el push test. Revisa consola/logs.");
        }
      } catch (e) {
        console.error("[PUSH TEST] error:", e);
        alert("âš ï¸ Error enviando push test. Revisa consola.");
      }
    }

    // ==========================================================
    // âœ… PWA Install (evento real + fallback)
    // ==========================================================
    (function () {
      let deferredPrompt = null;
      const btnInstall = document.getElementById("btn-install");

      function isStandalone() {
        return window.matchMedia("(display-mode: standalone)").matches
          || window.matchMedia("(display-mode: fullscreen)").matches
          || window.navigator.standalone === true; // iOS
      }

      function setBtnHidden() {
        if (!btnInstall) return;
        btnInstall.style.display = "none";
        btnInstall.onclick = null;
      }

      function setBtnReal() {
        if (!btnInstall) return;
        btnInstall.style.display = "inline-block";
        btnInstall.textContent = "ğŸ“² Instalar app";
        btnInstall.onclick = null;
      }

      function setBtnFallback() {
        if (!btnInstall) return;
        btnInstall.style.display = "inline-block";
        btnInstall.textContent = "ğŸ“Œ Instalar (menÃº â‹® del navegador)";
        btnInstall.onclick = () => {
          alert("En Chrome/Edge: menÃº â‹® â†’ 'Instalar app' o 'Agregar a pantalla de inicio'.\n\nSi ya estÃ¡ instalada, este botÃ³n no aparece.");
        };
      }

      function syncInstallButton() {
        if (!btnInstall) return;

        if (isStandalone()) {
          setBtnHidden();
          return;
        }

        if (deferredPrompt) {
          setBtnReal();
          return;
        }

        setBtnHidden();
      }

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        syncInstallButton();
      });

      if (btnInstall) {
        btnInstall.addEventListener("click", async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          syncInstallButton();
        });
      }

      window.addEventListener("appinstalled", () => {
        deferredPrompt = null;
        syncInstallButton();
      });

      syncInstallButton();

      window.addEventListener("load", () => {
        setTimeout(() => {
          if (!isStandalone() && !deferredPrompt) setBtnFallback();
        }, 1500);
      });
    })();

    // ==========================================================
    // âœ… Boot
    // ==========================================================
    (function () {
      window.addEventListener("load", async () => {
        const reg = await registerSW();
        await syncPushButtons(reg);

        if (btnPushApp)  btnPushApp.addEventListener("click", enablePushApp);
        if (btnPushTest) btnPushTest.addEventListener("click", sendTestPush);
      });
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>