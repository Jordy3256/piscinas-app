{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Admin{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .app-shell { max-width: 900px; margin: 0 auto; }
    .topbar { position: sticky; top: 0; z-index: 1030; backdrop-filter: blur(8px); }
    .bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1030; }
    .spacer-bottom { height: 88px; }
    .btn-install { display: none; }
    .bottom-nav .btn { white-space: nowrap; }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="/dashboard/manifest.json">
  <meta name="theme-color" content="#0d6efd">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  {% block extra_head %}{% endblock %}
</head>

<body class="bg-light">
  <div class="app-shell">

    <!-- Topbar -->
    <div class="topbar bg-white border-bottom">
      <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-bold">
            {% block top_title %}ğŸ§‘â€ğŸ’¼ Admin{% endblock %}
          </div>
          <div class="d-flex gap-2">
            {% block top_actions %}
              <a class="btn btn-outline-secondary btn-sm" href="/dashboard/">Inicio</a>
              <a class="btn btn-outline-danger btn-sm" href="/logout/">Salir</a>
            {% endblock %}
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido -->
    <div class="container py-3">
      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
      <div class="spacer-bottom"></div>
    </div>

    <!-- Bottom nav -->
    <div class="bottom-nav bg-white border-top">
      <div class="container py-2">
        <div class="d-flex justify-content-around gap-2 flex-wrap">
          <a class="btn btn-light flex-fill" href="/dashboard/">ğŸ  Inicio</a>
          <a class="btn btn-outline-secondary flex-fill" href="/dashboard/operativo/">ğŸ§‘â€ğŸ’¼ Operativo</a>
          <a class="btn btn-outline-secondary flex-fill" href="/dashboard/finanzas/flujo/">ğŸ’° Finanzas</a>
          <a class="btn btn-outline-secondary flex-fill" href="/admin/" target="_blank">âš™ï¸ Admin</a>

          <button id="btn-install" class="btn btn-primary flex-fill btn-install" type="button">
            ğŸ“² Instalar app
          </button>

          <button id="btn-enable-push" class="btn btn-outline-primary flex-fill" type="button">
            ğŸ”” Activar notificaciones
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // âœ… enablePush SIEMPRE definido (no rompe si lo llamas antes)
    window.enablePush = window.enablePush || (async function () {
      try {
        if (!("serviceWorker" in navigator)) return console.warn("[SW] no soportado");
        if (!("PushManager" in window) || !("Notification" in window)) return console.warn("[PUSH] no soportado");

        const reg = await navigator.serviceWorker.ready;

        if (Notification.permission === "denied") return console.warn("[PUSH] permiso denegado");
        if (Notification.permission === "default") {
          const perm = await Notification.requestPermission();
          console.log("[PUSH] permission:", perm);
          if (perm !== "granted") return;
        }

        const r = await fetch("/dashboard/push/public-key/", { credentials: "same-origin" });
        if (!r.ok) throw new Error("public-key status " + r.status);
        const data = await r.json();
        const publicKey = (data.publicKey || "").replace(/\s+/g, "").trim();
        if (!publicKey) return console.error("[PUSH] publicKey vacÃ­a");

        function urlBase64ToUint8Array(s) {
          s = (s || "").replace(/\s+/g, "").trim();
          const pad = "=".repeat((4 - (s.length % 4)) % 4);
          const b64 = (s + pad).replace(/-/g, "+").replace(/_/g, "/");
          const raw = atob(b64);
          const out = new Uint8Array(raw.length);
          for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
          return out;
        }

        let sub = await reg.pushManager.getSubscription();
        if (!sub) {
          sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey),
          });
        }

        function getCookie(name) {
          const v = ; ${document.cookie};
          const p = v.split(; ${name}=);
          if (p.length === 2) return p.pop().split(";").shift();
          return "";
        }

        const csrftoken = getCookie("csrftoken");
        const save = await fetch("/dashboard/save-subscription/", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify(sub.toJSON()),
        });

        const out = await save.json().catch(() => ({}));
        console.log("[PUSH] save:", save.status, out);
      } catch (e) {
        console.error("[enablePush] error:", e);
      }
    });

    window.addEventListener("load", () => {
      const btn = document.getElementById("btn-enable-push");
      if (btn) btn.addEventListener("click", () => window.enablePush());
    });

    // âœ… SW register
    (function () {
      if (!("serviceWorker" in navigator)) return;
      window.addEventListener("load", async () => {
        try {
          await navigator.serviceWorker.register("/dashboard/sw.js", { scope: "/dashboard/" });
        } catch (e) {
          console.error("[SW] error:", e);
        }
      });
    })();

    // âœ… PWA install
    (function () {
      let deferredPrompt = null;
      const btn = document.getElementById("btn-install");

      function isStandalone() {
        return window.matchMedia("(display-mode: standalone)").matches
          || window.matchMedia("(display-mode: fullscreen)").matches
          || window.navigator.standalone === true;
      }
      function showBtn(text) {
        if (!btn) return;
        btn.style.display = "inline-block";
        btn.textContent = text;
      }
      function hideBtn() {
        if (!btn) return;
        btn.style.display = "none";
      }
      function sync() {
        if (!btn) return;
        if (isStandalone()) return hideBtn();
        if (deferredPrompt) return showBtn("ğŸ“² Instalar app");
        hideBtn();
      }

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        sync();
      });
      window.addEventListener("appinstalled", () => {
        deferredPrompt = null;
        sync();
      });

      if (btn) {
        btn.addEventListener("click", async () => {
          if (!deferredPrompt) {
            alert("En Chrome/Edge: menÃº â‹® â†’ 'Instalar app' o 'Agregar a pantalla de inicio'.");
            return;
          }
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          sync();
        });
      }

      sync();
      window.addEventListener("load", () => {
        setTimeout(() => {
          if (!isStandalone() && !deferredPrompt) showBtn("ğŸ“Œ Instalar (menÃº â‹®)");
        }, 1500);
      });
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>