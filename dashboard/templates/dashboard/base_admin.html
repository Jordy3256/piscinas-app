{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{% block title %}Admin{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .app-shell { max-width: 900px; margin: 0 auto; }
    .topbar { position: sticky; top: 0; z-index: 1030; backdrop-filter: blur(8px); }
    .bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1030; }
    .spacer-bottom { height: 88px; }

    .btn-install { display: none; }
    .bottom-nav .btn { white-space: nowrap; }

    /* âœ… Botones push */
    #btn-push-admin { display: none; white-space: nowrap; }
    #btn-push-test  { display: none; white-space: nowrap; }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="/dashboard/manifest.json?v=20260225">
  <meta name="theme-color" content="#0d6efd">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  {% block extra_head %}{% endblock %}
</head>

<body class="bg-light">
  <div class="app-shell">

    <!-- Topbar -->
    <div class="topbar bg-white border-bottom">
      <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-bold">
            {% block top_title %}ğŸ§‘â€ğŸ’¼ Admin{% endblock %}
          </div>

          <div class="d-flex gap-2">
            {% block top_actions %}
              <button id="btn-push-admin" class="btn btn-primary btn-sm" type="button">ğŸ”” Activar</button>
              <button id="btn-push-test" class="btn btn-outline-primary btn-sm" type="button">ğŸ§ª Test Push</button>

              <!-- âœ… Inicio ahora va a /dashboard/home/ -->
              <a class="btn btn-outline-secondary btn-sm" href="/dashboard/home/">Inicio</a>
              <a class="btn btn-outline-danger btn-sm" href="/logout/">Salir</a>
            {% endblock %}
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido -->
    <div class="container py-3">
      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
      <div class="spacer-bottom"></div>
    </div>

    <!-- Bottom nav -->
    <div class="bottom-nav bg-white border-top">
      <div class="container py-2">
        <div class="d-flex justify-content-around gap-2 flex-wrap">
          <!-- âœ… Inicio ahora va a /dashboard/home/ -->
          <a class="btn btn-light flex-fill" href="/dashboard/home/">ğŸ  Inicio</a>
          <a class="btn btn-outline-secondary flex-fill" href="/dashboard/operativo/">ğŸ§‘â€ğŸ’¼ Operativo</a>
          <a class="btn btn-outline-secondary flex-fill" href="/dashboard/finanzas/flujo/">ğŸ’° Finanzas</a>
          <a class="btn btn-outline-secondary flex-fill" href="/admin/" target="_blank">âš™ï¸ Admin</a>

          <button id="btn-install" class="btn btn-primary flex-fill btn-install" type="button">
            ğŸ“² Instalar app
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ==========================================================
    // âœ… Config
    // ==========================================================
    const VAPID_PUBLIC_KEY = "{{ VAPID_PUBLIC_KEY|default:''|escapejs }}";

    // ==========================================================
    // âœ… CSRF robusto (meta -> cookie)
    // ==========================================================
    function getCSRFToken() {
      const meta = document.querySelector('meta[name="csrf-token"]');
      if (meta && meta.getAttribute("content")) return meta.getAttribute("content") || "";
      const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : "";
    }

    // ==========================================================
    // âœ… Utils
    // ==========================================================
    function urlBase64ToUint8Array(base64UrlString) {
      if (!base64UrlString || typeof base64UrlString !== "string") return null;
      const padding = "=".repeat((4 - (base64UrlString.length % 4)) % 4);
      const base64 = (base64UrlString + padding).replace(/-/g, "+").replace(/_/g, "/");
      const raw = atob(base64);
      const out = new Uint8Array(raw.length);
      for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
      return out;
    }

    async function unregisterGhostSW() {
      if (!("serviceWorker" in navigator)) return;
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) {
        const scope = r?.scope || "";
        if (scope.includes("/static/dashboard/")) {
          console.log("[SW] ğŸ§¹ Unregister viejo /static/dashboard/:", scope);
          await r.unregister();
        }
      }
    }

    async function registerSW() {
      if (!("serviceWorker" in navigator)) return null;
      await unregisterGhostSW();
      await navigator.serviceWorker.register("/dashboard/sw.js", { scope: "/dashboard/" });
      const ready = await navigator.serviceWorker.ready;
      return ready;
    }

    // ==========================================================
    // âœ… Save subscription  (âœ… URL corregida segÃºn tu urls.py)
    // ==========================================================
    async function sendSubscriptionToServer(sub) {
      const csrftoken = getCSRFToken();
      const res = await fetch("/dashboard/push/save_subscription/", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
          "Accept": "application/json",
        },
        body: JSON.stringify(sub.toJSON()),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        console.warn("[PUSH] save_subscription FAILED", res.status, data);
        return { ok: false, status: res.status, data };
      }
      console.log("[PUSH] saved âœ…", data);
      return { ok: true, data };
    }

    // ==========================================================
    // âœ… Push logic
    // ==========================================================
    const btnPushAdmin = document.getElementById("btn-push-admin");
    const btnPushTest  = document.getElementById("btn-push-test");

    function show(el) { if (el) el.style.display = "inline-block"; }
    function hide(el) { if (el) el.style.display = "none"; }

    async function syncPushButtons(reg) {
      if (!btnPushAdmin && !btnPushTest) return;

      if (!reg || !("PushManager" in window) || !("Notification" in window)) {
        hide(btnPushAdmin); hide(btnPushTest);
        return;
      }

      const sub = await reg.pushManager.getSubscription();
      const granted = (Notification.permission === "granted");

      if (sub && granted) {
        hide(btnPushAdmin);
        show(btnPushTest);
      } else {
        show(btnPushAdmin);
        hide(btnPushTest);
      }
    }

    async function enablePushAdmin() {
      try {
        const reg = await navigator.serviceWorker.ready;

        const perm = await Notification.requestPermission();
        if (perm !== "granted") {
          alert("No concediste el permiso de notificaciones.");
          return;
        }

        let sub = await reg.pushManager.getSubscription();
        if (!sub) {
          const keyBytes = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
          if (!keyBytes || !keyBytes.length) {
            alert("VAPID_PUBLIC_KEY invÃ¡lida (debe ser base64url).");
            console.error("[PUSH] keyBytes invÃ¡lido", VAPID_PUBLIC_KEY);
            return;
          }
          sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: keyBytes,
          });
        }

        const saved = await sendSubscriptionToServer(sub);
        if (saved.ok) {
          alert("âœ… Notificaciones activadas.");
          await syncPushButtons(reg);
        } else {
          alert("âš ï¸ SuscripciÃ³n creada pero no se guardÃ³ en el servidor. Revisa consola.");
        }
      } catch (e) {
        console.error("[PUSH] enablePushAdmin error:", e);
        alert("Error activando notificaciones. Revisa consola.");
      }
    }

    async function sendTestPush() {
      try {
        const csrftoken = getCSRFToken();
        const res = await fetch("/dashboard/push/test/", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "X-CSRFToken": csrftoken,
            "Accept": "application/json",
          },
        });

        const data = await res.json().catch(() => ({}));
        console.log("[PUSH TEST]", res.status, data);

        if (res.ok && data.ok) {
          alert("ğŸ“¨ Push test enviado. Revisa si te llegÃ³ la notificaciÃ³n.");
        } else {
          alert("âš ï¸ FallÃ³ el push test. Revisa consola/logs.");
        }
      } catch (e) {
        console.error("[PUSH TEST] error:", e);
        alert("âš ï¸ Error enviando push test. Revisa consola.");
      }
    }

    // ==========================================================
    // âœ… PWA Install
    // ==========================================================
    (function () {
      let deferredPrompt = null;
      const btn = document.getElementById("btn-install");

      function isStandalone() {
        return window.matchMedia("(display-mode: standalone)").matches
          || window.matchMedia("(display-mode: fullscreen)").matches
          || window.navigator.standalone === true;
      }

      function showBtn(text) {
        if (!btn) return;
        btn.style.display = "inline-block";
        btn.textContent = text;
      }

      function hideBtn() {
        if (!btn) return;
        btn.style.display = "none";
      }

      function sync() {
        if (!btn) return;
        if (isStandalone()) return hideBtn();
        if (deferredPrompt) return showBtn("ğŸ“² Instalar app");
        hideBtn();
      }

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        sync();
      });

      window.addEventListener("appinstalled", () => {
        deferredPrompt = null;
        sync();
      });

      if (btn) {
        btn.addEventListener("click", async () => {
          if (isStandalone()) return;
          if (!deferredPrompt) {
            alert("En Chrome/Edge: menÃº â‹® â†’ 'Instalar app' o 'Agregar a pantalla de inicio'.");
            return;
          }
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          sync();
        });
      }

      sync();

      window.addEventListener("load", () => {
        setTimeout(() => {
          if (!isStandalone() && !deferredPrompt) showBtn("ğŸ“Œ Instalar (menÃº â‹®)");
        }, 1500);
      });

      window.matchMedia("(display-mode: standalone)").addEventListener("change", sync);
    })();

    // ==========================================================
    // âœ… Boot
    // ==========================================================
    (function () {
      window.addEventListener("load", async () => {
        // 1) SW
        const reg = await registerSW();

        // 2) botones push (estado inicial)
        await syncPushButtons(reg);

        // 3) listeners
        if (btnPushAdmin) btnPushAdmin.addEventListener("click", enablePushAdmin);
        if (btnPushTest)  btnPushTest.addEventListener("click", sendTestPush);
      });
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>