{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Admin{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .app-shell { max-width: 900px; margin: 0 auto; }
    .topbar { position: sticky; top: 0; z-index: 1030; backdrop-filter: blur(8px); }
    .bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1030; }
    .spacer-bottom { height: 88px; }

    /* por defecto oculto; JS decide */
    .btn-install { display: none; }

    /* evita que el layout â€œsalteâ€ raro */
    .bottom-nav .btn { white-space: nowrap; }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="/dashboard/manifest.json">
  <meta name="theme-color" content="#0d6efd">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  {% block extra_head %}{% endblock %}
</head>

<body class="bg-light">
  <div class="app-shell">

    <!-- Topbar -->
    <div class="topbar bg-white border-bottom">
      <div class="container py-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-bold">
            {% block top_title %}ğŸ§‘â€ğŸ’¼ Admin{% endblock %}
          </div>
          <div class="d-flex gap-2">
            {% block top_actions %}
              <a class="btn btn-outline-secondary btn-sm" href="/dashboard/">Inicio</a>
              <a class="btn btn-outline-danger btn-sm" href="/logout/">Salir</a>
            {% endblock %}
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido -->
    <div class="container py-3">
      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
      <div class="spacer-bottom"></div>
    </div>

    <!-- Bottom nav -->
    <div class="bottom-nav bg-white border-top">
      <div class="container py-2">
        <div class="d-flex justify-content-around gap-2 flex-wrap">
          <a class="btn btn-light flex-fill" href="/dashboard/">ğŸ  Inicio</a>
          <a class="btn btn-outline-secondary flex-fill" href="/dashboard/operativo/">ğŸ§‘â€ğŸ’¼ Operativo</a>
          <a class="btn btn-outline-secondary flex-fill" href="/dashboard/finanzas/flujo/">ğŸ’° Finanzas</a>
          <a class="btn btn-outline-secondary flex-fill" href="/admin/" target="_blank">âš™ï¸ Admin</a>

          <button id="btn-install" class="btn btn-primary flex-fill btn-install" type="button">
            ğŸ“² Instalar app
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ==========================
    // SW register (scope correcto)
    // ==========================
    (function () {
      if (!("serviceWorker" in navigator)) {
        console.log("[SW] âŒ No soportado");
        return;
      }

      window.addEventListener("load", async () => {
        try {
          console.log("[SW] registrando /dashboard/sw.js ...");
          const reg = await navigator.serviceWorker.register("/dashboard/sw.js", { scope: "/dashboard/" });
          console.log("[SW] âœ… scope:", reg.scope);
        } catch (e) {
          console.error("[SW] âŒ error:", e);
        }
      });
    })();

    // ==========================
    // PWA Install (robusto)
    // ==========================
    (function () {
      let deferredPrompt = null;
      const btn = document.getElementById("btn-install");

      function isStandalone() {
        return window.matchMedia("(display-mode: standalone)").matches
          || window.matchMedia("(display-mode: fullscreen)").matches
          || window.navigator.standalone === true;
      }

      function showBtn(text) {
        if (!btn) return;
        btn.style.display = "inline-block";
        btn.textContent = text;
      }

      function hideBtn() {
        if (!btn) return;
        btn.style.display = "none";
      }

      function sync() {
        if (!btn) return;

        if (isStandalone()) {
          console.log("[PWA] âœ… ya instalada -> oculto");
          hideBtn();
          return;
        }

        // si existe evento real
        if (deferredPrompt) {
          console.log("[PWA] âœ… listo para instalar (beforeinstallprompt)");
          showBtn("ğŸ“² Instalar app");
          return;
        }

        // si no hay evento, lo ocultamos y luego mostramos ayuda (fallback)
        hideBtn();
      }

      window.addEventListener("beforeinstallprompt", (e) => {
        console.log("[PWA] beforeinstallprompt âœ…");
        e.preventDefault();
        deferredPrompt = e;
        sync();
      });

      window.addEventListener("appinstalled", () => {
        console.log("[PWA] ğŸ‰ appinstalled");
        deferredPrompt = null;
        sync();
      });

      if (btn) {
        btn.addEventListener("click", async () => {
          if (isStandalone()) return;

          // si no existe prompt real, mostramos ayuda
          if (!deferredPrompt) {
            alert("En Chrome/Edge: menÃº â‹® â†’ 'Instalar app' o 'Agregar a pantalla de inicio'.\n\nSi ya estÃ¡ instalada, este botÃ³n no aparece.");
            return;
          }

          deferredPrompt.prompt();
          const choice = await deferredPrompt.userChoice;
          console.log("[PWA] elecciÃ³n:", choice?.outcome);

          deferredPrompt = null;
          sync();
        });
      }

      // inicial
      sync();

      // fallback si nunca llega beforeinstallprompt
      window.addEventListener("load", () => {
        setTimeout(() => {
          if (!isStandalone() && !deferredPrompt) {
            console.log("[PWA] â„¹ï¸ no llegÃ³ beforeinstallprompt -> fallback");
            showBtn("ğŸ“Œ Instalar (menÃº â‹®)");
          }
        }, 1500);
      });

      window.matchMedia("(display-mode: standalone)").addEventListener("change", sync);
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
